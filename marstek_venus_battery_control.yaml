# ----------------
# TEMPLATE SENSORS
# ----------------
  
  template:
    - sensor:
        - name: "My M1 Charging in W"
          unique_id: my_m1_charging_in_w
          unit_of_measurement: W
          device_class: power
          state_class: measurement
          state: >
            {% if states('sensor.marstek_m1_ac_power') | float(0) < 0 %}
              {{ (states('sensor.marstek_m1__ac_power') | float(0)) *-1 }}
            {% else %}
              0
            {% endif %}
          
        - name: "My M1 Discharging in W"
          unique_id: my_m1_discharging_in_w
          unit_of_measurement: W
          device_class: power
          state_class: measurement
          state: >
            {% if states('sensor.marstek_m1_ac_power') | float(0) > 0 %}
              {{ (states('sensor.marstek_m1_ac_power') | float(0)) }}
            {% else %}
              0
            {% endif %}
        - name: "My M1 Efficiency Percentage"
          unique_id: my_m1_efficiency_percentage
          unit_of_measurement: "%"
          state_class: measurement
          state: >
            {% set charging = states('sensor.my_m1_daily_charging_in_kwh') | float(0) %}
            {% set discharging = states('sensor.my_m1_daily_discharging_in_kwh') | float(0) %}
            {% if charging > 0 %}
              {{ ((discharging / charging) * 100) | int }}
            {% else %}
              0
            {% endif %}

# -------
# SENSORS
# -------
  
  sensor:
    - platform: integration
      name: My M1 Discharging in kWh
      unique_id: my_m1_discharging_in_kwh
      source: sensor.my_m1_discharging_in_w
      round: 2
      unit_prefix: k
      unit_time: h
      method: left
    - platform: integration
      name: My M1 Charging in kWh
      unique_id: my_m1_charging_in_kwh
      source: sensor.my_m1_charging_in_w
      round: 2
      unit_prefix: k
      unit_time: h
      method: left

# --------------
# UTILITY METERS
# --------------
  utility_meter:
    daily_discharge:
      name: My M1 Daily Discharging in kWh
      unique_id: my_m1_daily_discharging_in_kwh
      source: sensor.my_m1_discharging_in_kwh
      cycle: daily

    daily_charge:
      name: My M1 Daily Charging in kWh
      unique_id: my_m1_daily_charging_in_kwh
      source: sensor.my_m1_charging_in_kwh
      cycle: daily

    weekly_discharge:
      name: My M1 Weekly Discharging in kWh
      unique_id: my_m1_weekly_discharging_in_kwh
      source: sensor.my_m1_discharging_in_kwh
      cycle: weekly

    weekly_charge:
      name: My M1 Weekly Charging in kWh
      unique_id: my_m1_weekly_charging_in_kwh
      source: sensor.my_m1_charging_in_kwh
      cycle: weekly

    monthly_discharge:
      name: My M1 Monthly Discharging in kWh
      unique_id: my_m1_monthly_discharging_in_kwh
      source: sensor.my_m1_discharging_in_kwh
      cycle: monthly

    monthly_charge:
      name: My M1 Monthly Charging in kWh
      unique_id: my_m1_monthly_charging_in_kwh
      source: sensor.my_m1_charging_in_kwh
      cycle: monthly

    yearly_discharge:
      name: My M1 Yearly Discharging in kWh
      unique_id: my_m1_yearly_discharging_in_kwh
      source: sensor.my_m1_discharging_in_kwh
      cycle: yearly

    yearly_charge:
      name: My M1 Yearly Charging in kWh
      unique_id: my_m1_yearly_charging_in_kwh
      source: sensor.my_m1_charging_in_kwh
      cycle: yearly

